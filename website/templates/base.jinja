{% set game = engine.current_game %}
{% set config = game.config %}
{% set page = engine.current_page %}

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Baloo+2">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename="flouze.css") }}" type="text/css">
    <link rel = "icon" href ="{{ url_for('static', filename="images/coin.png") }}" type="image/x-icon">
    <title>{% block title %}Home{% endblock %}</title>
  </head>

<body style="background-image: url({{ url_for("static", filename="images/" + config["background"]) }}); min-height: 100vh; display:flex; flex-direction:column; justify-content:flex-start;">

{% block player_money %}
<!--Top bar with money-->
<div class="w3-container w3-text-white" style="height:50px; background-color:{{ config["theme_colors"][0] }}">
  <div class="w3-right huge"><span id="flouze">{{ player.flouze }}</span> <img src="{{ url_for('static', filename="images/coin.png") }}" class="coin-large" alt="Coin"></div>
</div>

<!--Saved Flouze for game 3-->
{% if player.saved_flouze %}
<div class="w3-text-white w3-text-white large w3-round-large" style="text-align:right; padding:2px 16px; position:absolute; top:40px; right:0; background-color:{{ config["theme_colors"][0] }}">({{ player.saved_flouze }} <img src="{{ url_for("static", filename="images/coin.png") }}" class="coin-medium" alt="Coin">)</div>
<div style="height:28px">*</div>
{% endif %}
{% endblock %}

<!--Stars Table-->
{% block stars_table %}
<div class="w3-display-topleft" style="width:115px">
  {% for player_it in engine.players %}
    <div class="w3-border-0 w3-padding-small" style="background-color:{{ player_it.color["primary"] }}">{{ player_it.name }}<i id="player{{ loop.index0 }}_star" class="fa fa-star w3-right" style="position:relative; top:4px;"> {{ player_it.stars }}</i></div>
  {% endfor %}
</div>
{% endblock %}

<!--Donation button-->
{% block donation_button %}
<form method="GET" action="faire_un_don" class="w3-center" style="margin: 16px 0 0 115px;">
<button type="submit" class="w3-btn w3-round-large w3-green medium" style="border:2px solid #fff">Faire un don</button>
</form>
{% endblock %}

<!--History button-->
{% block history %}
<button onclick="document.getElementById('history').style.display='block'" class="w3-button w3-circle medium w3-text-white" style="position:absolute; top:60px; right:10px; border:2px solid #fff; background-color:{{ config["theme_colors"][0] }}"><i class="fa fa-history" style="position:relative; top:1px;"></i></button>
<div id="history" class="w3-modal">
  <div id="history_list" class="w3-modal-content w3-padding" style="background-color:{{ config["theme_colors"][1] }}">
    <span onclick="document.getElementById('history').style.display='none'" class="w3-button w3-display-topright w3-xlarge" style="padding:1px 16px;">&times;</span>
    {% for time, _, msg, _ in player.messages %}
    {{ time.strftime('%H:%M : ') + msg }}<br>
    {% endfor %}
  </div>
</div>
{% endblock %}

<!--Content-->
<div style="width: 100%; display:flex; flex-direction:column; justify-content:space-evenly; align-items:center; flex-grow: 1">
{% block content %} {% endblock %}
</div>

<!--Toasts-->
<div style="position:absolute; bottom:5px; width:100%">
<div id="messages" class="toast">
{% for category, message in get_flashed_messages(with_categories=true) %}
  {% if category == "error" %}
  <div class="w3-pale-red w3-round-large w3-border w3-border-red w3-padding-small" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; margin-left: 5px; margin-right: 5px;">
    <i class="fa fa-exclamation-circle w3-text-red" style="margin-right: 6px;"></i>
    <div class="w3-center">{{ message }}</div>
    <span onclick="this.parentElement.style.display='none'" class="w3-hover-gray w3-center w3-round-large" style="width: 25px; position:relative; left:3px">&times;</span>
  </div>
  {% else %}
  <div class="w3-pale-green w3-round-large w3-border w3-border-green w3-padding-small" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; margin-left: 5px; margin-right: 5px;">
    <i class="fa fa-info-circle w3-text-green" style="margin-right: 6px;"></i>
    <div class="w3-center">{{ message }}</div>
    <span onclick="this.parentElement.style.display='none'" class="w3-hover-gray w3-center w3-large w3-round-large" style="width: 25px; position:relative; left:3px">&times;</span>
  </div>
  {% endif %}
{% endfor %}

{% for is_request, message_id, message in player.messages_to_show %}
  {% if is_request %}
  <div class="w3-pale-yellow w3-round-large w3-border w3-border-yellow w3-padding-small" style="margin-bottom:5px;">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <i class="fa fa-question-circle w3-text-yellow" style="margin-right: 6px;"></i>
      <div class="w3-center">{{ message }}</div>
    </div>
    <button onclick="this.parentElement.style.display='none'; hide_message({{ message_id }}); answer_flouze_request(true);" class="w3-button w3-round-large w3-green w3-center" style="padding:3px; width:90px">Envoyer</i></button>
    <button onclick="this.parentElement.style.display='none'; hide_message({{ message_id }}); answer_flouze_request(false);" class="w3-button w3-round-large w3-red w3-center" style="padding:3px; width:90px">Refuser</button>
  </div>
  {% else %}
  <div class="w3-pale-green w3-round-large w3-border w3-border-green w3-padding-small" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; margin-left: 5px; margin-right: 5px;">
    <i class="fa fa-info-circle w3-text-green" style="margin-right: 6px;"></i>
    <div class="w3-center">{{ message }}</div>
    <span onclick="this.parentElement.style.display='none'; hide_message({{ message_id }});" class="w3-hover-gray w3-center w3-large w3-round-large" style="width: 25px; position:relative; left:3px">&times;</span>
  </div>
  {% endif %}
{% endfor %}
</div>
</div>

 <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js" integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA==" crossorigin="anonymous"></script>
  <script type="text/javascript" charset="utf-8">
    if (navigator.userAgent.match(/Android/i)) {
      window.scrollTo(0, 1);
    }
    var socket = io();
    socket.on('connect', function() {
        socket.emit('give_identity', '{{ player.name }}');
    });
    socket.on('message', function(message_id, message) {
      document.getElementById('messages').innerHTML += `
      <div class="w3-pale-green w3-round-large w3-border w3-border-green w3-padding-small" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; margin-left: 5px; margin-right: 5px;">
        <i class="fa fa-info-circle w3-text-green" style="margin-right: 6px;"></i>
        <div class="w3-center">` + message + `</div>
        <span onclick="this.parentElement.style.display='none'; hide_message(` + message_id + `);" class="w3-hover-gray w3-center w3-large w3-round-large" style="width: 25px; position:relative; left:3px">&times;</span>
      </div>
      `;
      document.getElementById('history_list').innerHTML += message + '<br>';
    });
    socket.on('request', function(message_id, message) {
      document.getElementById('messages').innerHTML += `
      <div class="w3-pale-yellow w3-round-large w3-border w3-border-yellow w3-padding-small" style="margin-bottom:5px; margin-left: 5px; margin-right: 5px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <i class="fa fa-question-circle w3-text-yellow" style="margin-right: 6px;"></i>
          <div class="w3-center">` + message + `</div>
        </div>
        <button onclick="this.parentElement.style.display='none'; hide_message({{ message_id }}); answer_flouze_request(true);" class="w3-button w3-round-large w3-green w3-center" style="padding:3px; width:90px">Envoyer</i></button>
        <button onclick="this.parentElement.style.display='none'; hide_message({{ message_id }}); answer_flouze_request(false);" class="w3-button w3-round-large w3-red w3-center" style="padding:3px; width:90px">Refuser</button>
      </div>
      `;
      document.getElementById('history_list').innerHTML += message + '<br>';
    }
    socket.on('waiting_count', function(count) {
        document.getElementById('count').innerHTML = count;
    });
    socket.on('update_data', function(changes) {
      for (i = 0; i < changes.length; i++) {
        object_id = changes[i][0];
        value = changes[i][1];
        var obj = document.getElementById(object_id);
        if (obj != null) { obj.innerHTML = value; }
      }
    });
    socket.on('reveal_card', function(card_id) {
        var card = document.getElementById('card' + card_id);
        if (card != null) {
          card.style.transform = "rotateY(180deg)";
        }
    });
    socket.on('move_to_frame', function(frame_id) {
        var frame = document.querySelector("iframe");
        if (frame == null) return;
        var player = frame.contentWindow.sozi.player;
        player.moveToFrame(frame_id % player.presentation.frames.length);
    });
    socket.on('refresh', function() {
        window.location = window.location;
    });
    function update_choice(obj) {
      if (typeof prev != 'undefined') 
        prev.parentNode.classList.remove('checked');
      obj.parentNode.classList.add('checked');
      prev = obj;
    }
    function hide_message(message_id) {
      socket.emit('hide_message', message_id);
    }
    function answer_flouze_request(answer) {
      socket.emit('answer_flouze_request');
    }
    function disableBack() { window.history.forward(); }
    setTimeout("disableBack()", 0);
    window.onunload = function () { null };
  </script>

  </body>
</html>
